name: Validate & Deploy

on:
  push:
    branches: [main]

jobs:
    validate:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4

        - name: Setup PHP
          uses: shivammathur/setup-php@v2
          with:
            php-version: '8.2'

        - name: PHP Syntax Check
          run: find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \; | grep -v "No syntax errors" && exit 1 || true

        - name: Install Dependencies
          run: composer install --no-dev --prefer-dist

    deploy:
      needs: validate
      runs-on: ubuntu-latest
      steps:
        - name: Deploy to VPS
          uses: appleboy/ssh-action@v1
          with:
            host: ${{ secrets.VPS_HOST }}
            username: ${{ secrets.VPS_USER }}
            key: ${{ secrets.VPS_SSH_KEY }}
            script: |
              cd ${{ secrets.VPS_PATH }}
              git pull origin main
              composer install --no-dev --prefer-dist
              sudo systemctl restart queue-scheduler
              sudo systemctl restart queue-worker