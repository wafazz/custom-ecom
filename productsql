-- Drop tables if they exist
DROP TABLE IF EXISTS variant_attribute_values;
DROP TABLE IF EXISTS product_attribute_values;
DROP TABLE IF EXISTS product_attributes;
DROP TABLE IF EXISTS product_variants;
DROP TABLE IF EXISTS products;
DROP TABLE IF EXISTS brands;

-- Brands table
CREATE TABLE brands (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL
);

-- Products table
CREATE TABLE products (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) NOT NULL UNIQUE,
    description TEXT,
    type ENUM('simple', 'variable') NOT NULL DEFAULT 'simple',
    brand_id INT UNSIGNED,
    status TINYINT(1) DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (brand_id) REFERENCES brands(id) ON DELETE SET NULL
);

-- Product Variants table
CREATE TABLE product_variants (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    product_id INT UNSIGNED NOT NULL,
    sku VARCHAR(100) UNIQUE,
    price DECIMAL(10,2) NOT NULL,
    stock INT UNSIGNED DEFAULT 0,
    image VARCHAR(255),
    status TINYINT(1) DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
);

-- Product Attributes
CREATE TABLE product_attributes (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL
);

-- Attribute Values
CREATE TABLE product_attribute_values (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    attribute_id INT UNSIGNED NOT NULL,
    value VARCHAR(100) NOT NULL,
    FOREIGN KEY (attribute_id) REFERENCES product_attributes(id) ON DELETE CASCADE
);

-- Variant Attribute Values
CREATE TABLE variant_attribute_values (
    variant_id INT UNSIGNED NOT NULL,
    attribute_value_id INT UNSIGNED NOT NULL,
    PRIMARY KEY (variant_id, attribute_value_id),
    FOREIGN KEY (variant_id) REFERENCES product_variants(id) ON DELETE CASCADE,
    FOREIGN KEY (attribute_value_id) REFERENCES product_attribute_values(id) ON DELETE CASCADE
);

-- Insert brand
INSERT INTO brands (name, slug) VALUES ('Generic', 'generic');

-- Insert simple product
INSERT INTO products (name, slug, description, type, brand_id)
VALUES ('Water Bottle', 'water-bottle', 'A reusable water bottle.', 'simple', 1);

-- Simple product variant (only one)
INSERT INTO product_variants (product_id, sku, price, stock)
VALUES (1, 'WB-001', 10.99, 100);

-- Insert variable product
INSERT INTO products (name, slug, description, type, brand_id)
VALUES ('T-Shirt', 't-shirt', 'Cotton T-shirt in various sizes and colors.', 'variable', 1);

-- Insert product attributes
INSERT INTO product_attributes (name) VALUES ('Color'), ('Size');

-- Insert attribute values
INSERT INTO product_attribute_values (attribute_id, value) VALUES
(1, 'Red'),
(1, 'Blue'),
(2, 'M'),
(2, 'L');

-- Insert variants
INSERT INTO product_variants (product_id, sku, price, stock)
VALUES
(2, 'TSHIRT-RED-M', 15.00, 50),
(2, 'TSHIRT-RED-L', 15.00, 40),
(2, 'TSHIRT-BLUE-M', 15.00, 30);

-- Link variants to attributes
-- Red + M
INSERT INTO variant_attribute_values (variant_id, attribute_value_id) VALUES (2, 1), (2, 3);

-- Red + L
INSERT INTO variant_attribute_values (variant_id, attribute_value_id) VALUES (3, 1), (3, 4);

-- Blue + M
INSERT INTO variant_attribute_values (variant_id, attribute_value_id) VALUES (4, 2), (4, 3);
